---
title: "Exercices chapter 2"
author: "Joan Claverol Romero"
date: "09/12/2019"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, fig.align = "center")
# libraries
if (require(pacman) == FALSE) {
  install.packages("pacman")
}
pacman::p_load(tidyverse, scales, lubridate, readxl, 
               kableExtra, knitr, formattable, gridExtra)
```

## CHAPTER 2

### EXERCISE 1 Improve this table

```{r}
ex_1 <- read_excel("../data/storytelling_practice/chapter_2/2.1 EXERCISE.xlsx",
                   col_types = c(
                     "text", "numeric", "numeric","numeric", "numeric"
                     )
                   )

# save and rds file
write_rds(ex_1, "2_1_EX.rds")

# plot the table
kable(ex_1 %>% 
        mutate(
          `% Accounts` = percent(`% Accounts`),
          `Revenue ($M)` = dollar(`Revenue ($M)`),
          `% Revenue` = percent(`% Revenue`)
          )
      ) %>% 
  kable_styling(bootstrap_options = c("responsive","striped"), 
                full_width = F)
```

##### STEP 1: Review the data in Figure 2.1a. What observations can you make? Do you have to make any assumptions when interpreting this data? What questions do you have about this data?

* We should add a *total*. Then we will realize some problems

```{r}
# Find out the actual information
rest <- ex_1 %>%
  summarise_if(is.numeric, sum) %>%
  mutate(Tier = "Rest") %>% 
  select(Tier, everything()) %>% 
  bind_rows(ex_1) %>% 
  filter(Tier == "Rest")

# Create the other missing data 
Other <- tibble(
  Tier = "Other",
  `# of Accounts` = (rest[[2]]*(1 - rest[[3]]))/rest[[3]],
  `% Accounts` = 1 - rest[[3]],
  `Revenue ($M)` = (rest[[4]]*(1 - rest[[5]]))/rest[[5]],
  `% Revenue` = 1 - rest[[5]]
)

# bind the information to add the total 
final_table <- ex_1 %>% 
  bind_rows(Other) %>%
  summarise_if(is.numeric, sum) %>% 
  mutate(Tier = "Total") %>% 
  select(Tier, everything()) %>% 
  bind_rows(ex_1 %>% 
              bind_rows(Other)) %>% 
  mutate(
    Tier = factor(Tier, levels = c("A+","A", "B", "C", "D", "Other", "Total"))
    ) %>% 
  arrange(Tier)
```

It should be a 100% on Accounts and Revenue (%). Something wrong. 

* Round % to only one digit. 
* The number of accounts with a Tier C is the higher one. Is it clearly seen in the column *% Accounts*. 
* The revenue is higher at Tier B, also weel represented on the *% Revenue*. 

##### STEP 2:  Consider the layout of the table in Figure 2.1a. Let’s assume you’ve been told this information must be communicated in a table. Are there any changes you would make to the way the data is presented or the overall manner in which the table is designed?

* I recommend against shading every other row and instead am an advocate for white space (and limited light borders) to set apart columns and rows as needed.

```{r}
final_table %>%
  mutate(
    `% Accounts` = percent(`% Accounts`, digits = 0),
    `Revenue ($M)` = dollar(`Revenue ($M)`),
    `% Revenue` = percent(`% Revenue`, digits = 0)
    ) %>% 
  kable(
    col.names = c("Tier","#", "% OF TOT", "$M", "% OF TOT"), align = "c"
    ) %>% 
  column_spec(5, width = "3cm") %>% 
  column_spec(
    3, border_right = T, extra_css = "border-right: 2px solid;"
    ) %>%
  pack_rows(
    start_row = 7, end_row = 7, hline_before = T, 
    label_row_css = "border-bottom: 2px solid;line-height: 0;padding: 0;"
    ) %>% 
  row_spec(0, bold = T, color = "black", background = "ghostwhite", 
           extra_css = "border-bottom: 2px solid #777777;") %>% 
  column_spec(1, bold = T, color = "black", background = "ghostwhite", 
              extra_css = "border-right: 2px solid #777777;") %>% 
  add_header_above(header = c(" " = 1, "Accounts" = 2, "Revenue" = 2), 
                   bold = T, color = "black", background = "ghostwhite", 
                   extra_css = "border-left: 2px solid #777777;") %>% 
  kable_styling(bootstrap_options = c("responsive", "bordered"), 
                full_width = F)
```

Try to apply a better format. but let's find out a better chart: 

```{r eval=FALSE}
final_table %>% 
  filter(Tier != "Total") %>% 
  mutate(`% Accounts` = color_bar("red")(`% Accounts`)) %>% 
  # start to build the table
  kable(escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(5, width = "3cm") %>%
  add_header_above(c(" ", "Hello" = 2, "World" = 2))
```

##### Tranform the data to pie charts

Improve the next chart: 

![](../documentation/2_2_PieChart.png)

Create the pie chart: 

```{r}
# add other in the data
all_ex_1 <- ex_1 %>% 
  bind_rows(Other) %>% 
  mutate(
    Tier = factor(Tier, levels = c("Other","D","C", "B", "A","A+"))
    ) 

# plot the pie chart Accounts
pie_accounts <- all_ex_1 %>% 
  ggplot(aes(x = "", y = `% Accounts`, fill = Tier)) +
    geom_col(stat = "identity", width = 1) +
    # Convert to pie (polar coordinates) and add labels
    coord_polar("y", start = 0) + 
    geom_text(
      aes(
        label = Tier#percent(`% Accounts`, digits = 0)
        ), 
      position = position_stack(vjust = 0.7), 
      color = "white", cex = 4.25
      ) + 
    # Add color scale (hex colors)
    scale_fill_manual(
      values=c("#55DDE0", "#33658A", "#2F4858", "#F6AE2D", "#F26419", "#999999")
      ) +
    # Remove labels and add title
    labs(x = NULL, y = NULL, fill = NULL, title = "% Total of Accounts") + 
    # Tidy up the theme
    theme_classic() + 
    theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5, color = "#666666"), 
          legend.position = "none")

# plot the pie chart Accounts
pie_revenue <- all_ex_1 %>% 
  ggplot(aes(x = "", y = `% Revenue`, fill = Tier)) +
    geom_col(stat = "identity", width = 1) +
    # Convert to pie (polar coordinates) and add labels
    coord_polar("y", start = 0) + 
    geom_text(
      aes(label = Tier), 
      position = position_stack(vjust = 0.7), 
      color = "white", cex = 4.25
      ) + 
    # Add color scale (hex colors)
    scale_fill_manual(
      values=c("#55DDE0", "#33658A", "#2F4858", "#F6AE2D", "#F26419", "#999999")
      ) +
    # Remove labels and add title
    labs(x = NULL, y = NULL, fill = NULL, title = "% Total of Revenue") + 
    # Tidy up the theme
    theme_classic() + 
    theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5, color = "#666666"), 
          legend.position = "none")

# grid the plots 
grid.arrange(pie_accounts, pie_revenue, nrow = 1)
```

Other ways to improve a pie chart in this stackOverflow [link](https://stackoverflow.com/questions/16184188/ggplot-facet-piechart-placing-text-in-the-middle-of-pie-chart-slices/47645727)

But the best wat to represent that information would be: 

```{r, fig.width=8}
# coord plots for accounts
bar_accounts <- all_ex_1 %>% 
  ggplot(aes(x = Tier, y = `% Accounts`)) +
    geom_col(fill = "dodgerblue4", width = 0.7) + 
    coord_flip() + 
    geom_text(aes(label = if_else(`% Accounts` > 0.05, 
                                  percent(`% Accounts`, digits = 0), NULL)),
              hjust = 1.1, color = "white", size = 4.5) + 
    labs(
      title = expression(paste("TIER |       % OF TOTAL ", bold("ACCOUNTS")))
      ) +
    theme_void() +
    theme(
      plot.title = element_text(hjust = -0.75),
      axis.title.y = element_blank(), 
      axis.text.y = element_text(face = "bold", size = 13),
      axis.title.x = element_blank(),
      axis.text.x = element_blank()
    )

# coord plots for revenue
bar_revenue <- all_ex_1 %>% 
  ggplot(aes(x = Tier, y = `% Revenue`)) +
    geom_col(fill = "dodgerblue4", width = 0.7) + 
    coord_flip() + 
    geom_text(aes(label = if_else(`% Revenue` > 0.05, 
                                  percent(`% Revenue`, digits = 0), NULL)),
              hjust = 1.1, color = "white", size = 4.5) + 
    labs(title = expression(paste("   |       % OF TOTAL ", bold("REVENUE")))) +
    theme_void() +
    theme(
      plot.title = element_text(),
      axis.title.y = element_blank(), 
      axis.text.y = element_blank(),
      axis.title.x = element_blank(),
      axis.text.x = element_blank(), 
      
    )

# merge both chart
grid.arrange(bar_accounts, bar_revenue, nrow = 1)
```

Last step to improve the chart: 

```{r}
# create teh table
pivot_ex_1 <- all_ex_1 %>% 
  select(Tier, `% Accounts`, `% Revenue`) %>% 
  mutate(`% Accounts` = round(`% Accounts`, 2)) %>% 
  pivot_longer(cols = -Tier, names_to = "names", values_to = "perc") 

# define the colors used on the plot
used_colors <- c("#6fc3ff", "dodgerblue4")

# create the plot
pivot_ex_1 %>%
  ggplot(aes(x = Tier, y = perc, fill = names)) +
    geom_col(position = "dodge", width = 0.7) +
    coord_flip() +
    scale_y_continuous(labels = percent_format(accuracy = 1), position = "right") +
    scale_fill_manual(
      values = c("#6FB8FF", "dodgerblue4"), 
      labels = c("% ACCOUNTS","% REVENUE")
      ) +
    labs(
      title = "% OF TOTAL ACCOUNTS vs. REVENUE\n"
      ) +
    theme_void() + 
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.y = element_blank(), 
      axis.text.y = element_text(face = "bold", size = 12),
      axis.line.y = element_blank(),
      axis.title.x = element_blank(),
      axis.text.x = element_text(), 
      axis.line.x = element_line(size = 0.5),
      legend.position = "top", 
      legend.justification = "left", 
      legend.title = element_blank(),
      plot.margin = unit(c(1, 4, 1, 1), "lines")
      ) 

```

We can flip that chart: 

```{r}
pivot_ex_1 %>%
  ggplot(aes(x = Tier, y = perc, fill = names)) +
    geom_col(position = "dodge", width = 0.7) +
    scale_y_continuous(labels = percent, position = "left") +
    scale_y_continuous(labels = percent_format(accuracy = 1), position = "left") +
    scale_fill_manual(
      values = c("#6FB8FF", "dodgerblue4"), 
      labels = c("% ACCOUNTS","% REVENUE")
      ) +
    labs(
      title = "% OF TOTAL ACCOUNTS vs. REVENUE\n"
      ) +
    theme_void() + 
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.y = element_blank(), 
      axis.text.y = element_text(face = "bold", size = 12),
      axis.line.y = element_line(size = 0.5),
      axis.title.x = element_blank(),
      axis.text.x = element_text(), 
      axis.line.x = element_blank(),
      legend.position = "top", 
      legend.justification = "left", 
      legend.title = element_blank(),
      plot.margin = unit(c(1, 4, 1, 1), "lines")
      ) 
```

Help the user to understand the difference between the different levels:

```{r}
pivot_ex_1 %>%
  ggplot(aes(x = Tier, y = perc)) +
    geom_col(aes(fill = names), position = "dodge", width = 0.7) +
    geom_point(aes(group = names), position = position_dodge(width = 0.75), inherit.aes = TRUE) +
    geom_line(aes(group = Tier)) +
    scale_y_continuous(labels = percent_format(accuracy = 1), position = "left") +
    scale_fill_manual(
      values = c("#6fc3ff", "dodgerblue4"), 
      labels = c("% ACCOUNTS","% REVENUE")
      ) +
    labs(
      title = "% OF TOTAL ACCOUNTS vs. REVENUE\n"
      ) +
    theme_void() + 
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.y = element_blank(), 
      axis.text.y = element_text(face = "bold", size = 12),
      axis.line.y = element_line(size = 0.5),
      axis.title.x = element_blank(),
      axis.text.x = element_text(), 
      axis.line.x = element_blank(),
      legend.position = "top", 
      legend.justification = "left", 
      legend.title = element_blank(),
      plot.margin = unit(c(1, 4, 1, 1), "lines")
      ) 
```

That would be the same than: 

```{r}
pivot_ex_1 %>%
  ggplot(aes(x = Tier, y = perc)) +
    geom_point(aes(group = names), position = "identity") +
    geom_line(aes(group = Tier)) +
    scale_y_continuous(labels = percent_format(accuracy = 1), position = "left") +
    scale_fill_manual(
      values = c("#6FB8FF", "dodgerblue4"), 
      labels = c("% ACCOUNTS","% REVENUE")
      ) +
    labs(
      title = "% OF TOTAL ACCOUNTS vs. REVENUE\n"
      ) +
    theme_void() + 
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.y = element_blank(), 
      axis.text.y = element_text(face = "bold", size = 12),
      axis.line.y = element_line(size = 0.5),
      axis.title.x = element_blank(),
      axis.text.x = element_text(), 
      axis.line.x = element_blank(),
      legend.position = "top", 
      legend.justification = "left", 
      legend.title = element_blank(),
      plot.margin = unit(c(1, 4, 1, 1), "lines")
      ) 
```

And we can transform that information to:

```{r}
# define palette of colors 
library(RColorBrewer)
my_blues <- brewer.pal(n = 9, "Blues")[4:9]

pivot_ex_1 %>% 
  # pivot_wider(names_from = names, values_from = perc) %>% 
  ggplot(aes(x = names, y = perc, group = Tier, col = Tier)) +
    geom_point() + 
    geom_line() +
    geom_text(aes(label = if_else(
          names == "% Accounts", percent(perc, digits = 0), NULL
          )), hjust = 1.5) +
    geom_text(aes(label = if_else(
          names == "% Revenue", percent(perc, digits = 0), NULL
          )), hjust = -0.5) +
    scale_color_manual(values = my_blues) +
    scale_x_discrete(labels = c("% TOT.\nACCOUNTS", "% TOT.\nREVENUE")) +
    labs(title = "% OF TOTAL ACCOUNTS vs. REVENUE\n") +
    theme_void() + 
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.y = element_blank(), 
      axis.text.y = element_blank(),
      axis.title.x = element_blank(),
      axis.text.x = element_text(), 
      axis.line.x = element_blank(),
      legend.position = "right", 
      legend.justification = "left",
      legend.text = element_text(size = 12),
      legend.title = element_blank(),
      plot.margin = unit(c(1, 4, 1, 1), "lines")
      ) 
```

### EXERCISE 2 Improve the table

Let’s look at another table. The following shows the number of meals served each
year as part of a corporate giving program. Spend a moment looking at the data.
What is interesting about it?

```{r}
ex_2 <- read_excel("../data/storytelling_practice/chapter_2/2.2 EXERCISE.xlsx")

# transform to year
library(lubridate)
# ex_2 %>% 
#   mutate(`Campaign Year` = ymd(`Campaign Year`))
```

* In a table we can create a heat map to show how the meals served increase or decrease across the years

But let's do a bar graph: 

```{r}
ex_2 %>% 
  ggplot(aes(x = factor(`Campaign Year`), y = `Meals Served`)) + 
    geom_col(fill = "dodgerblue4", width = 0.7) + 
    theme_void() +
    labs(title = "Meals served over time") +
    xlab(label = "CAMPAIGN YEAR") +
    ylab(label = "# OF MEALS SERVED") +
    scale_y_continuous(labels = scales::number, 
                       breaks = seq(0, max(ex_2$`Meals Served`),50000)) +
    # scale_x_continuous(labels = scales::number_format(accuracy = 1, big.mark = "")) +
    theme(
      axis.title.x = element_text(hjust = 0), 
      axis.title.y = element_text(hjust = 1), 
      axis.text = element_text()
    )
    
```

Now a line chart: 

```{r}
ex_2 %>% 
  ggplot(aes(x = `Campaign Year`, y = `Meals Served`)) + 
    geom_line(color = "dodgerblue4") +
    geom_point(aes(y = if_else(`Campaign Year` == min(`Campaign Year`) |
                         `Campaign Year` == max(`Campaign Year`),
                         `Meals Served`, NULL)), col = "dodgerblue4") +
    geom_text(aes(label = if_else(`Campaign Year` == min(`Campaign Year`), 
                                  number(`Meals Served`, big.mark = ","), NULL)),
              vjust = 1.5, col = "dodgerblue4") +
    geom_text(aes(label = if_else(`Campaign Year` == max(`Campaign Year`), 
                                  number(`Meals Served`, big.mark = ","), NULL)),
              vjust = -1, col = "dodgerblue4") +
    theme_void() +
    labs(title = "Meals served over time", 
         subtitle = "# OF MEALS SERVED") +
    xlab(label = "CAMPAIGN YEAR") +
    ylim(0, max(ex_2$`Meals Served`)) +
    scale_x_continuous(labels = as.character(ex_2$`Campaign Year`), 
                       breaks = ex_2$`Campaign Year`) +
    theme(
      axis.title.x = element_text(hjust = 0),
      axis.text.x = element_text(),
      axis.line.x = element_line(),
      axis.title.y = element_blank(),
      axis.text.y = element_blank()
    )
```

### EXERCISE 3 & 4

```{r fig.width=4, fig.height=5}
ex_3 <- read_excel("../data/storytelling_practice/chapter_2/2.3 EXERCISE.xlsx")

# format to the data
library(lubridate)
library(magrittr)
ex_3 %<>% 
  mutate(DATE = parse_date_time(DATE, "%Y-%m"), 
         YEAR = year(DATE), 
         MONTH = factor(
           str_to_upper(month(DATE, label = F)),
           levels = seq(1,12,1),
           labels = c("JAN","FEB","MAR","APR","MAY","JUN","JUL",
                      "AUG","SEP","OCT","NOV","DEC")),
         UNMET_DEMAND = DEMAND - CAPACITY
         ) %>% 
  arrange(desc(YEAR, MONTH)) 

# prepare the data
ex_3_2019 <- ex_3 %>% 
  filter(YEAR == 2019) %>% 
  select(-DATE, -YEAR) %>% 
  pivot_longer(cols = -MONTH, names_to = "names", values_to = "values") 

# plot the data
ex_3_2019 %>% 
  filter(names != "UNMET_DEMAND") %>% 
  ggplot(aes(x = MONTH, y = values)) +
    geom_col(aes(fill = names), position = "dodge", col = "black") +
    coord_flip() +
    geom_text(aes(group = names, label = number(values, big.mark = ".")), 
              position = position_dodge(width = 1), inherit.aes = TRUE,
              hjust = -0.1, size = 3.5) +
    ylim(0, 57000) + 
    labs(title = "Demand and capacity by Month") + 
    theme_void() +
    theme(
      legend.position = "bottom", 
      legend.title = element_blank(), 
      axis.text.y = element_text(size = 10)
    )
```


Bar chart to create plots: 

```{r}
# initial plot
ex_3_2019 %>% 
  filter(names != "UNMET_DEMAND") %>% 
  ggplot(aes(x = MONTH, y = values)) +
    geom_col(aes(fill = factor(names, levels = c("DEMAND","CAPACITY"))), 
             position = "dodge", color = "dodgerblue4") +
    scale_fill_manual(values = used_colors) + 
    scale_y_continuous(labels = number_format(big.mark = ".")) +
    labs(title = "Demand and capacity by Month\n") + 
    ylab("NUMBER OF PROJECT HOURS") + xlab("2019") +
    theme_void() +
    theme(
      legend.position = "top",
      legend.justification = "left",
      legend.title = element_blank(), 
      axis.title = element_text(colour = "gray58"),
      axis.text.y = element_text(size = 10, color = "gray58"),
      axis.title.y = element_text(hjust = 1),
      axis.text.x = element_text(size = 9, color = "gray58"),
      axis.title.x = element_text(hjust = 0), 
    )

```

Or a line chart: 

```{r}
# plot the results
ex_3_2019 %>% 
  filter(names != "UNMET_DEMAND") %>% 
  ggplot(aes(x = MONTH, y = values)) +
    geom_line(aes(color = names, group = names)) +
    geom_text(aes(label = if_else(
      MONTH == "DEC" & names == "DEMAND", 
      number(round(values/1000), suffix = "K DEMAND"), NULL)
      ), 
      col = used_colors[2], hjust = 0.6, vjust = 1.5) +
    geom_text(aes(label = if_else(
      MONTH == "DEC" & names == "CAPACITY", 
      number(round(values/1000), suffix = "K CAPACITY"), NULL)), 
      col = used_colors[1], hjust = 0.6, vjust = -0.75) +
    scale_color_manual(values = used_colors) + 
    scale_y_continuous(labels = scales::number_format(big.mark = "."), 
                       breaks = seq(0, max(ex_3_2019$values),10000), 
                       limits = c(0, 55000)) +
    labs(title = "Demand and capacity by Month\n") + 
    ylab("NUMBER OF PROJECT HOURS") + xlab("2019") +
    theme_void() +
    theme(
      legend.position = "none",
      axis.title = element_text(colour = "gray58"),
      axis.line = element_line(color = "gray58"),
      axis.text.y = element_text(size = 10, color = "gray58"),
      axis.title.y = element_text(hjust = 1),
      axis.text.x = element_text(size = 9, color = "gray58"),
      axis.title.x = element_text(hjust = 0), 
    )
```

A Bar chart with alpha: 

```{r}
ex_3_2019 %>%
  filter(names != "UNMET_DEMAND") %>%
  pivot_wider(names_from = "names", values_from = "values") %>% 
  ggplot(aes(x = MONTH)) +
    geom_col(aes(y = DEMAND), 
             color = "dodgerblue4", fill = "white", width = 0.4) +
    geom_col(aes(y = CAPACITY), fill = "dodgerblue4", alpha = 0.4, width = 0.7) +
    scale_fill_manual(values = used_colors) + 
    scale_y_continuous(labels = number_format(big.mark = ".")) +
    labs(title = "Demand and capacity by Month", 
         subtitle = "Demand vs. capacity month by month\n") + 
    ylab("NUMBER OF PROJECT HOURS") + xlab("MONTH") +
    theme_void() +
    theme(
      legend.position = "top",
      legend.justification = "left",
      legend.title = element_blank(), 
      axis.title = element_text(colour = "gray58"),
      axis.text.y = element_text(size = 10, color = "gray58"),
      axis.title.y = element_text(hjust = 1),
      axis.text.x = element_text(size = 9, color = "gray58"),
      axis.title.x = element_text(hjust = 0), 
    )

```


A bar chart to show the unmet demand: 

```{r}
ex_3_2019 %>%
  filter(names != "DEMAND") %>% 
  ggplot(aes(x = MONTH, y = values, 
             fill = factor(names, levels = c("UNMET_DEMAND", "CAPACITY")))) +
    geom_col(position = "stack", color = "dodgerblue4") +
    scale_fill_manual(values = c(used_colors[2], used_colors[1])) + 
    scale_y_continuous(labels = number_format(big.mark = "."), 
                       limits = c(0, 60000), 
                       breaks = seq(0, 60000, 10000)) +
    labs(title = "Demand vs. capacity over 2019\n") + 
    ylab("NUMBER OF PROJECT HOURS") + xlab("MONTH") +
    theme_void() +
    theme(
      legend.position = "top",
      legend.justification = "left",
      legend.title = element_blank(), 
      axis.title = element_text(colour = "gray58"),
      axis.text.y = element_text(size = 10, color = "gray58"),
      axis.title.y = element_text(hjust = 1),
      axis.text.x = element_text(size = 9, color = "gray58"),
      axis.title.x = element_text(hjust = 0), 
    )
```

Use points to show the same information: 

```{r}
ex_3_2019 %>% 
  filter(names != "UNMET_DEMAND") %>% 
  ggplot(aes(x = MONTH, y = values)) +
    geom_line(aes(group = MONTH), size = 10, color = "gray58") +
    geom_point(aes(color = names, group = names), size = 10, shape = 21, fill = "white") + 
    geom_text(aes(label = round(values/1000), color = names)) +
  
    # geom_text(aes(label = if_else(
    #   MONTH == "2020-03" & names == "DEMAND", values, NULL)
    #   ), 
    #   col = used_colors[2], hjust = 0.5, vjust = -0.5) +
    # geom_text(aes(label = if_else(
    #   MONTH == "2020-03" & names == "CAPACITY", values, NULL)), 
    #   col = used_colors[1], hjust = 0.5, vjust = 1.5) +
    scale_color_manual(values = used_colors) + 
    scale_y_continuous(labels = scales::number_format(big.mark = "."), 
                       breaks = seq(0, max(ex_3_2019$values),5000), 
                       limits = c(0, 55000)) +
    labs(title = "Demand vs. capacity over 2019\n") + 
    ylab("NUMBER OF PROJECT HOURS (THOUSANDS)") + xlab("2019") +
    theme_void() +
    theme(
      legend.position = "top",
      legend.justification = "left",
      legend.title = element_blank(), 
      axis.title = element_text(colour = "gray58"),
      axis.title.y = element_text(hjust = 1),
      axis.text.x = element_text(size = 9, color = "gray58"),
      axis.title.x = element_text(hjust = 0, color = "gray58"), 
      axis.line.x = element_line(color = "gray58")
    )
```

Or create a line plot with the unmet demand: 

```{r}
ex_3_2019 %>% 
  filter(names == "UNMET_DEMAND") %>% 
  mutate(GROUP = "1") %>% 
  ggplot(aes(x = MONTH, y = values)) +
    geom_line(aes(group = GROUP), color = "dodgerblue4") +
    geom_point(color = "dodgerblue4") +
    scale_y_continuous(labels = number_format(big.mark = "."), 
                       breaks = seq(0, 30000, 5000), 
                       limits = c(0, 30000)) +
    labs(title = "Unmet demand over 2019\n") + 
    ylab("NUMBER OF PROJECT HOURS") + xlab("2019") +
    theme_void() +
    theme(
      legend.position = "top",
      legend.justification = "left",
      legend.title = element_blank(), 
      axis.line = element_line(color = "gray58"),
      axis.title = element_text(colour = "gray58"),
      axis.text.y = element_text(size = 10, color = "gray58"),
      axis.title.y = element_text(hjust = 1),
      axis.text.x = element_text(size = 9, color = "gray58"),
      axis.title.x = element_text(hjust = 0), 
    )
```

### EXERCISE 5

The following table shows attrition rate for a 1-year associate training program for
a given company. Spend a moment familiarizing yourself with it, then answer the
following questions.

```{r}
ex_5 <- read_excel("../data/storytelling_practice/chapter_2/2.5 EXERCISE.xlsx")
```

Define average value and filter it our from the data: 

```{r}
# filter out average
ex_5_raw <- ex_5 %>% 
  filter(Year != "AVG")

# select average
ex_5_avg <- ex_5 %>% 
  filter(Year == "AVG")

# define colo 
col <- "dodgerblue4"
# scatter plot
ex_5_raw %>% 
  ggplot(aes(x = Year, y = `Attrition Rate`)) +
    geom_point(color = col, size = 3) +
    geom_hline(yintercept =  ex_5_avg$`Attrition Rate`, linetype = "dashed", 
               col = col) +
    annotate(geom = "text", x = 1.5, y = ex_5_avg$`Attrition Rate` + 0.005, 
             label = paste("AVERAGE: ", round(ex_5_avg$`Attrition Rate`*100, 1),
                           "%"), 
             col = col) +
    scale_y_continuous(labels = percent_format(accuracy = 1), 
                       breaks = seq(0,0.18,0.02), 
                       limits = c(0,0.16)) + 
    labs(title = "Attrition rate over time\n") +
    ylab("ATTRITION RATE") +
    theme_void() +
    theme(
      legend.position = "top",
      legend.justification = "left",
      legend.title = element_blank(), 
      axis.line = element_line(color = "gray58"),
      axis.text.y = element_text(size = 10, color = "gray58"),
      axis.title.y = element_text(hjust = 1, color = "gray58"),
      axis.text.x = element_text(size = 9, color = "gray58")    
      )
```

Use a line graph to show the evolution over time: 

```{r}
ex_5_raw %>% 
  mutate(GROUP = "1") %>% 
  ggplot(aes(x = Year, y = `Attrition Rate`)) +
    geom_line(aes(group = GROUP), color = col, size = 1) +
    geom_point(aes(y = if_else(Year == "2019", `Attrition Rate`, NULL)), 
               col = col, size = 3) +
    geom_hline(yintercept =  ex_5_avg$`Attrition Rate`, linetype = "dashed", 
               col = col) +
    geom_text(aes(label = if_else(Year == "2019", 
                                  paste(round(`Attrition Rate`*100,1),"%"),
                                  NULL)), 
              col = col, vjust = -1, hjust = 0.25) +
    annotate(geom = "text", x = 9.5, y = ex_5_avg$`Attrition Rate` - 0.005, 
             label = paste("AVG: ", round(ex_5_avg$`Attrition Rate`*100, 1),
                           "%"), 
             col = col) +
    scale_y_continuous(labels = percent_format(accuracy = 1), 
                       breaks = seq(0,0.18,0.02), 
                       limits = c(0,0.16)) + 
    labs(title = "Attrition rate over time\n") +
    ylab("ATTRITION RATE") +
    theme_void() +
    theme(
      legend.position = "top",
      legend.justification = "left",
      legend.title = element_blank(), 
      axis.line = element_line(color = "gray58"),
      axis.text.y = element_text(size = 10, color = "gray58"),
      axis.title.y = element_text(hjust = 1, color = "gray58"),
      axis.text.x = element_text(size = 9, color = "gray58")    
      )

```

